(function(){
const Materials={EMPTY:0,SAND:1,WATER:2,STONE:3,SOIL:4,SEED:5,PLANT:6,FIRE:7};
let w,h,ctx,grid,buf,img,pix;
function initCA(c,w0,h0){w=w0;h=h0;ctx=c.getContext('2d');grid=new Uint8Array(w*h);buf=new Uint8Array(w*h);img=ctx.createImageData(w,h);pix=img.data;}
function id(x,y){return x+y*w;}
function stepCA(){for(let y=h-1;y>=0;--y){for(let x=0;x<w;x++){const i=id(x,y),v=grid[i];switch(v){case Materials.SAND:{const b=id(x,y+1);if(y+1<h&&grid[b]===Materials.EMPTY){buf[b]=v;buf[i]=0;}else if(y+1<h&&x>0&&grid[id(x-1,y+1)]===0){buf[id(x-1,y+1)]=v;buf[i]=0;}else if(y+1<h&&x+1<w&&grid[id(x+1,y+1)]===0){buf[id(x+1,y+1)]=v;buf[i]=0;}else buf[i]=v;break;}case Materials.WATER:{const b=id(x,y+1);if(y+1<h&&grid[b]===0){buf[b]=v;buf[i]=0;}else{let moved=false;for(const d of[-1,1]){if(x+d>=0&&x+d<w&&grid[id(x+d,y)]===0){buf[id(x+d,y)]=v;buf[i]=0;moved=true;break;}}if(!moved)buf[i]=v;}break;}case Materials.SEED:{const b=id(x,y+1);if(y+1<h&&grid[b]===0){buf[b]=v;buf[i]=0;}else if(Math.random()<0.001&&grid[b]===Materials.SOIL){buf[i]=Materials.PLANT;}else buf[i]=v;break;}case Materials.FIRE:{if(Math.random()<0.2){buf[i]=0;}else{for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){if(dx||dy){const nx=x+dx,ny=y+dy;if(nx>=0&&nx<w&&ny>=0&&ny<h){const ni=id(nx,ny);if(grid[ni]===Materials.PLANT||grid[ni]===Materials.SEED)buf[ni]=Materials.FIRE;}}}buf[i]=v;}break;}default:buf[i]=v;}}}
[grid,buf]=[buf,grid];for(let i=0;i<grid.length;i++){const v=grid[i],p=i*4;switch(v){case Materials.SAND:pix[p]=194;pix[p+1]=178;pix[p+2]=128;pix[p+3]=255;break;case Materials.WATER:pix[p]=64;pix[p+1]=64;pix[p+2]=255;pix[p+3]=255;break;case Materials.STONE:pix[p]=128;pix[p+1]=128;pix[p+2]=128;pix[p+3]=255;break;case Materials.SOIL:pix[p]=101;pix[p+1]=67;pix[p+2]=33;pix[p+3]=255;break;case Materials.SEED:pix[p]=200;pix[p+1]=200;pix[p+2]=0;pix[p+3]=255;break;case Materials.PLANT:pix[p]=34;pix[p+1]=139;pix[p+2]=34;pix[p+3]=255;break;case Materials.FIRE:pix[p]=255;pix[p+1]=80;pix[p+2]=0;pix[p+3]=255;break;default:pix[p]=85;pix[p+1]=85;pix[p+2]=85;pix[p+3]=255;}}
ctx.putImageData(img,0,0);}
function paint(x,y,m,r){for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){if(dx*dx+dy*dy<=r*r){const nx=x+dx,ny=y+dy;if(nx>=0&&nx<w&&ny>=0&&ny<h)grid[id(nx,ny)]=m;}}}
function getStats(){const s={};for(const k in Materials)s[k]=0;for(const v of grid){for(const k in Materials)if(Materials[k]===v){s[k]++;break;}}return s;}
window.Materials=Materials;window.initCA=initCA;window.stepCA=stepCA;window.paint=paint;window.getStats=getStats;
})();
